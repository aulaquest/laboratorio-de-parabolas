<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Laboratorio de Parábolas (Final v2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            font-size: 92%;
        }
        .slider-container {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 0.75rem; /* Reduced gap */
            align-items: center;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        canvas {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            background-color: #f8fafc;
            cursor: grab;
            width: 100%;
            height: 70vh; /* Controlled height */
            display: block; /* Ensures no extra space below canvas */
            touch-action: none; /* Important for mobile interaction on the canvas itself */
        }
        .btn-active {
            background-color: #4f46e5;
            color: white;
        }
        .latex {
            font-family: "Computer Modern", "Latin Modern", serif;
            font-style: italic;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">

    <div class="container mx-auto p-4 max-w-screen-2xl">
        
        <!-- Botones de Navegación -->
        <div class="flex justify-center mb-6 bg-gray-200 rounded-lg p-1 space-x-1 max-w-2xl mx-auto">
            <button id="btn-sim1" class="px-3 py-2 font-semibold rounded-md flex-1 transition-colors duration-300 btn-active text-sm">Forma Estándar</button>
            <button id="btn-sim2" class="px-3 py-2 font-semibold rounded-md flex-1 transition-colors duration-300 text-sm">Vértice y Raíces</button>
            <button id="btn-sim3" class="px-3 py-2 font-semibold rounded-md flex-1 transition-colors duration-300 text-sm">Foco y Directriz</button>
        </div>

        <!-- =============================================================== -->
        <!-- == CONTENEDOR PRINCIPAL - UNIFIED LAYOUT ====================== -->
        <!-- =============================================================== -->
        <div class="grid grid-cols-1 md:grid-cols-10 bg-white rounded-lg shadow-md overflow-hidden">
            
            <!-- Columna Izquierda: Canvas -->
            <div class="md:col-span-7 p-4">
                <canvas id="parabolaCanvas"></canvas>
            </div>

            <!-- Columna Derecha: Panel de Control Unificado -->
            <div class="md:col-span-3 p-6 border-t md:border-t-0 md:border-l border-gray-200 flex flex-col gap-4">
                
                <!-- Sección de Sliders (Controles Principales) -->
                <div>
                    <div id="controls-sim1">
                        <h2 class="text-lg font-bold mb-4">Forma Estándar</h2>
                        <p class="mb-4 text-center text-base font-mono bg-gray-100 p-2 rounded-lg"><span class="latex">y = ax<sup>2</sup> + bx + c</span></p>
                        <div class="space-y-4">
                            <div class="slider-container"><label for="sliderA1" class="font-semibold text-sm latex">a =</label><input type="range" id="sliderA1" min="-2" max="2" step="0.05" value="0.5" class="w-full h-2 bg-gray-200 rounded-lg"><span id="valueA1" class="font-mono text-sm w-12 text-center">0.50</span></div>
                            <div class="slider-container"><label for="sliderB1" class="font-semibold text-sm latex">b =</label><input type="range" id="sliderB1" min="-5" max="5" step="0.1" value="0" class="w-full h-2 bg-gray-200 rounded-lg"><span id="valueB1" class="font-mono text-sm w-12 text-center">0.00</span></div>
                            <div class="slider-container"><label for="sliderC1" class="font-semibold text-sm latex">c =</label><input type="range" id="sliderC1" min="-5" max="5" step="0.1" value="0" class="w-full h-2 bg-gray-200 rounded-lg"><span id="valueC1" class="font-mono text-sm w-12 text-center">0.00</span></div>
                        </div>
                    </div>
                    <div id="controls-sim2" class="hidden">
                        <h2 class="text-lg font-bold mb-4">Vértice, Eje y Raíces</h2>
                        <p class="mb-4 text-center text-base font-mono bg-gray-100 p-2 rounded-lg"><span class="latex">y = ax<sup>2</sup> + bx + c</span></p>
                        <div class="space-y-4">
                            <div class="slider-container"><label for="sliderA2" class="font-semibold text-sm latex">a =</label><input type="range" id="sliderA2" min="-2" max="2" step="0.05" value="0.5" class="w-full h-2 bg-gray-200 rounded-lg"><span id="valueA2" class="font-mono text-sm w-12 text-center">0.50</span></div>
                            <div class="slider-container"><label for="sliderB2" class="font-semibold text-sm latex">b =</label><input type="range" id="sliderB2" min="-5" max="5" step="0.1" value="0" class="w-full h-2 bg-gray-200 rounded-lg"><span id="valueB2" class="font-mono text-sm w-12 text-center">0.00</span></div>
                            <div class="slider-container"><label for="sliderC2" class="font-semibold text-sm latex">c =</label><input type="range" id="sliderC2" min="-5" max="5" step="0.1" value="0" class="w-full h-2 bg-gray-200 rounded-lg"><span id="valueC2" class="font-mono text-sm w-12 text-center">0.00</span></div>
                        </div>
                    </div>
                    <div id="controls-sim3" class="hidden">
                        <h2 class="text-lg font-bold mb-4">Foco y Directriz</h2>
                        <p class="mb-4 text-center text-base font-mono bg-gray-100 p-2 rounded-lg"><span class="latex">y = <sup>1</sup>&frasl;<sub>4p</sub> (x-h)<sup>2</sup> + k</span></p>
                        <div class="space-y-4">
                            <div class="slider-container"><label for="sliderP" class="font-semibold text-sm latex">p =</label><input type="range" id="sliderP" min="-5" max="5" step="0.1" value="1" class="w-full h-2 bg-gray-200 rounded-lg"><span id="valueP" class="font-mono text-sm w-12 text-center">1.00</span></div>
                            <div class="slider-container"><label for="sliderH" class="font-semibold text-sm latex">h =</label><input type="range" id="sliderH" min="-5" max="5" step="0.1" value="0" class="w-full h-2 bg-gray-200 rounded-lg"><span id="valueH" class="font-mono text-sm w-12 text-center">0.00</span></div>
                            <div class="slider-container"><label for="sliderK" class="font-semibold text-sm latex">k =</label><input type="range" id="sliderK" min="-5" max="5" step="0.1" value="0" class="w-full h-2 bg-gray-200 rounded-lg"><span id="valueK" class="font-mono text-sm w-12 text-center">0.00</span></div>
                        </div>
                    </div>
                </div>

                <hr class="my-4">

                <!-- Sección de Checkboxes (Opciones de Visualización) -->
                <div>
                    <div id="viz-sim1">
                        <h3 class="text-base font-semibold mb-3">Visualizar Términos</h3>
                        <div class="space-y-3">
                            <div class="checkbox-container"><input type="checkbox" id="checkTermA" class="h-4 w-4 rounded text-indigo-600"><label for="checkTermA">Mostrar <span class="latex text-red-600">y = ax<sup>2</sup></span></label></div>
                            <div class="checkbox-container"><input type="checkbox" id="checkTermB" class="h-4 w-4 rounded text-indigo-600"><label for="checkTermB">Mostrar <span class="latex text-green-600">y = bx</span></label></div>
                            <div class="checkbox-container"><input type="checkbox" id="checkTermC" class="h-4 w-4 rounded text-indigo-600"><label for="checkTermC">Mostrar <span class="latex text-blue-600">y = c</span></label></div>
                        </div>
                    </div>
                    <div id="viz-sim2" class="hidden">
                        <h3 class="text-base font-semibold mb-3">Visualizar Elementos</h3>
                        <div class="space-y-3">
                            <div class="checkbox-container"><input type="checkbox" id="checkVertex" class="h-4 w-4 rounded text-indigo-600" checked><label for="checkVertex">Mostrar Vértice</label></div>
                            <div class="checkbox-container ml-6"><input type="checkbox" id="checkVertexCoords" class="h-4 w-4 rounded text-indigo-600" checked><label for="checkVertexCoords">Mostrar Coordenadas</label></div>
                            <div class="checkbox-container"><input type="checkbox" id="checkAxis" class="h-4 w-4 rounded text-indigo-600" checked><label for="checkAxis">Mostrar Eje de Simetría</label></div>
                            <div class="checkbox-container"><input type="checkbox" id="checkRoots" class="h-4 w-4 rounded text-indigo-600" checked><label for="checkRoots">Mostrar Raíces</label></div>
                            <div class="checkbox-container ml-6"><input type="checkbox" id="checkRootsCoords" class="h-4 w-4 rounded text-indigo-600" checked><label for="checkRootsCoords">Mostrar Coordenadas</label></div>
                        </div>
                    </div>
                    <div id="viz-sim3" class="hidden">
                        <h3 class="text-base font-semibold mb-3">Visualizar Elementos</h3>
                        <div class="space-y-3">
                            <div class="checkbox-container"><input type="checkbox" id="checkFocus" class="h-4 w-4 rounded text-indigo-600" checked><label for="checkFocus">Mostrar Foco</label></div>
                            <div class="checkbox-container"><input type="checkbox" id="checkDirectrix" class="h-4 w-4 rounded text-indigo-600" checked><label for="checkDirectrix">Mostrar Directriz</label></div>
                            <div class="checkbox-container"><input type="checkbox" id="checkInteractivePoint" class="h-4 w-4 rounded text-indigo-600" checked><label for="checkInteractivePoint">Mostrar Punto en la Parábola</label></div>
                        </div>
                    </div>
                </div>
                
                <hr class="my-4">

                <!-- Botón de Reinicio -->
                <button id="btn-reset" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300">
                    Reiniciar Simulación
                </button>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center mt-6">
             <p class="text-sm text-gray-500">
                Simulación creada por <a href="https://aulaquest.com" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline">AulaQuest</a>
            </p>
        </footer>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Referencias a Elementos del DOM ---
        const canvas = document.getElementById('parabolaCanvas');
        const ctx = canvas.getContext('2d');
        const btnReset = document.getElementById('btn-reset');

        const navButtons = { sim1: document.getElementById('btn-sim1'), sim2: document.getElementById('btn-sim2'), sim3: document.getElementById('btn-sim3') };
        
        const controlPanels = { sim1: document.getElementById('controls-sim1'), sim2: document.getElementById('controls-sim2'), sim3: document.getElementById('controls-sim3') };
        const vizPanels = { sim1: document.getElementById('viz-sim1'), sim2: document.getElementById('viz-sim2'), sim3: document.getElementById('viz-sim3') };

        // --- Estado de la Aplicación ---
        let activeSim = 'sim1';
        let scale = 70;
        let origin = { x: 0, y: 0 }; 
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let parabolaPointX = 2; 
        let pinchStartDist = 0; // For pinch-to-zoom
        
        const colors = {
            parabola: '#4f46e5', axis: '#a1a1aa', grid: '#e2e8f0', termA: '#ef4444', termB: '#22c55e', termC: '#3b82f6',
            vertex: '#8b5cf6', roots: '#f97316', focus: '#14b8a6', directrix: '#ec4899', text: '#1f2937', interactive: '#f59e0b'
        };

        const sliderA1 = document.getElementById('sliderA1'), valueA1 = document.getElementById('valueA1');
        const sliderB1 = document.getElementById('sliderB1'), valueB1 = document.getElementById('valueB1');
        const sliderC1 = document.getElementById('sliderC1'), valueC1 = document.getElementById('valueC1');
        const checkTermA = document.getElementById('checkTermA'), checkTermB = document.getElementById('checkTermB'), checkTermC = document.getElementById('checkTermC');

        const sliderA2 = document.getElementById('sliderA2'), valueA2 = document.getElementById('valueA2');
        const sliderB2 = document.getElementById('sliderB2'), valueB2 = document.getElementById('valueB2');
        const sliderC2 = document.getElementById('sliderC2'), valueC2 = document.getElementById('valueC2');
        const checkVertex = document.getElementById('checkVertex'), checkVertexCoords = document.getElementById('checkVertexCoords');
        const checkAxis = document.getElementById('checkAxis'), checkRoots = document.getElementById('checkRoots'), checkRootsCoords = document.getElementById('checkRootsCoords');
        
        const sliderP = document.getElementById('sliderP'), valueP = document.getElementById('valueP');
        const sliderH = document.getElementById('sliderH'), valueH = document.getElementById('valueH');
        const sliderK = document.getElementById('sliderK'), valueK = document.getElementById('valueK');
        const checkFocus = document.getElementById('checkFocus'), checkDirectrix = document.getElementById('checkDirectrix'), checkInteractivePoint = document.getElementById('checkInteractivePoint');

        const toCanvasX = x => origin.x + x * scale;
        const toCanvasY = y => origin.y - y * scale;
        const fromCanvasX = canvasX => (canvasX - origin.x) / scale;
        const fromCanvasY = canvasY => (canvasY - origin.y) / -scale;

        function resizeCanvas() {
            canvas.width = canvas.clientWidth; // Match drawing buffer to CSS width
            canvas.height = canvas.clientHeight; // Match drawing buffer to CSS height
            origin = { x: canvas.width / 2, y: canvas.height * 0.8 }; 
            draw();
        }

        function drawGridAndAxes() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.strokeStyle = colors.grid;
            ctx.lineWidth = 1;
            const xMin = Math.floor(fromCanvasX(0)), xMax = Math.ceil(fromCanvasX(canvas.width));
            const yMin = Math.floor(fromCanvasY(canvas.height)), yMax = Math.ceil(fromCanvasY(0));
            for (let i = xMin; i <= xMax; i++) { ctx.beginPath(); ctx.moveTo(toCanvasX(i), 0); ctx.lineTo(toCanvasX(i), canvas.height); ctx.stroke(); }
            for (let i = yMin; i <= yMax; i++) { ctx.beginPath(); ctx.moveTo(0, toCanvasY(i)); ctx.lineTo(canvas.width, toCanvasY(i)); ctx.stroke(); }
            ctx.strokeStyle = colors.axis;
            ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(0, origin.y); ctx.lineTo(canvas.width, origin.y); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(origin.x, 0); ctx.lineTo(origin.x, canvas.height); ctx.stroke();
            ctx.fillStyle = colors.text;
            ctx.font = "11px Inter";
            for (let i = xMin; i <= xMax; i++) { if (i !== 0) ctx.fillText(i, toCanvasX(i) + 4, origin.y + 12); }
            for (let i = yMin; i <= yMax; i++) { if (i !== 0) ctx.fillText(i, origin.x + 4, toCanvasY(i) - 4); }
            ctx.fillText("0", origin.x + 4, origin.y + 12);
            ctx.restore();
        }
        
        function plotFunction(func, color, lineWidth = 2, dashes = []) {
            ctx.save();
            ctx.strokeStyle = color; ctx.lineWidth = lineWidth; ctx.setLineDash(dashes);
            ctx.beginPath();
            const startX = fromCanvasX(0), endX = fromCanvasX(canvas.width), step = 1 / scale;
            ctx.moveTo(toCanvasX(startX), toCanvasY(func(startX)));
            for (let x = startX; x <= endX; x += step) { ctx.lineTo(toCanvasX(x), toCanvasY(func(x))); }
            ctx.stroke();
            ctx.restore();
        }

        function drawPoint(x, y, color, radius = 5) {
            ctx.save(); ctx.fillStyle = color;
            ctx.beginPath(); ctx.arc(toCanvasX(x), toCanvasY(y), radius, 0, 2 * Math.PI); ctx.fill();
            ctx.restore();
        }

        function drawText(text, x, y, color, font = '14px Inter', align = 'left', baseline = 'bottom') {
            ctx.save();
            ctx.font = font;
            const textMetrics = ctx.measureText(text);
            const textWidth = textMetrics.width;
            const textHeight = parseInt(font, 10);
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.75)';
            ctx.fillRect(toCanvasX(x) - 3, toCanvasY(y) - textHeight - 1, textWidth + 6, textHeight + 6);

            ctx.fillStyle = color;
            ctx.textAlign = align;
            ctx.textBaseline = baseline;
            ctx.fillText(text, toCanvasX(x), toCanvasY(y));
            ctx.restore();
        }
        
        function drawLine(x1, y1, x2, y2, color, lineWidth = 1, dashes = []) {
            ctx.save(); ctx.strokeStyle = color; ctx.lineWidth = lineWidth; ctx.setLineDash(dashes);
            ctx.beginPath(); ctx.moveTo(toCanvasX(x1), toCanvasY(y1)); ctx.lineTo(toCanvasX(x2), toCanvasY(y2)); ctx.stroke();
            ctx.restore();
        }

        function drawSim1() {
            const a = +sliderA1.value, b = +sliderB1.value, c = +sliderC1.value;
            plotFunction(x => a * x * x + b * x + c, colors.parabola, 3);
            
            const yVisibleMin = fromCanvasY(canvas.height);
            const yVisibleMax = fromCanvasY(0);

            if (checkTermA.checked) {
                const func = x => a * x * x;
                plotFunction(func, colors.termA);
                const xPos = fromCanvasX(canvas.width * 0.85);
                const yPos = func(xPos);
                const clampedY = Math.max(yVisibleMin + 0.5, Math.min(yPos, yVisibleMax - 0.5));
                drawText(`y = ${a.toFixed(2)}x²`, xPos, clampedY, colors.termA, '14px Inter');
            }
            if (checkTermB.checked) {
                const func = x => b * x;
                plotFunction(func, colors.termB);
                const xPos = fromCanvasX(canvas.width * 0.15);
                const yPos = func(xPos);
                const clampedY = Math.max(yVisibleMin + 0.5, Math.min(yPos, yVisibleMax - 0.5));
                 drawText(`y = ${b.toFixed(2)}x`, xPos, clampedY, colors.termB, '14px Inter');
            }
            if (checkTermC.checked) {
                const func = x => c;
                plotFunction(func, colors.termC);
                const xPos = fromCanvasX(canvas.width * 0.1);
                const clampedY = Math.max(yVisibleMin + 0.5, Math.min(func(xPos), yVisibleMax - 0.5));
                drawText(`y = ${c.toFixed(2)}`, xPos, clampedY, colors.termC, '14px Inter');
            }
        }
        
        function drawSim2() {
            const a = +sliderA2.value, b = +sliderB2.value, c = +sliderC2.value;
            plotFunction(x => a * x * x + b * x + c, colors.parabola, 3);
            if (a === 0) return;
            const vx = -b / (2 * a), vy = a * vx * vx + b * vx + c;
            if (checkVertex.checked) {
                drawPoint(vx, vy, colors.vertex);
                if (checkVertexCoords.checked) drawText(`V(${vx.toFixed(2)}, ${vy.toFixed(2)})`, vx + 0.2, vy, colors.vertex, '14px Inter', 'left', 'top');
            }
            if (checkAxis.checked) {
                drawLine(vx, fromCanvasY(canvas.height), vx, fromCanvasY(0), colors.axis, 2, [5, 5]);
            }
            if (checkRoots.checked) {
                const disc = b * b - 4 * a * c;
                if (disc >= 0) {
                    const r1 = (-b + Math.sqrt(disc)) / (2 * a);
                    drawPoint(r1, 0, colors.roots);
                    if (checkRootsCoords.checked) drawText(`(${r1.toFixed(2)}, 0)`, r1 + 0.2, 0.5, colors.roots, '14px Inter');
                    if (disc > 0) {
                        const r2 = (-b - Math.sqrt(disc)) / (2 * a);
                        drawPoint(r2, 0, colors.roots);
                        if (checkRootsCoords.checked) drawText(`(${r2.toFixed(2)}, 0)`, r2 + 0.2, 0.5, colors.roots, '14px Inter');
                    }
                }
            }
        }

        function drawSim3() {
            const p = +sliderP.value, h = +sliderH.value, k = +sliderK.value;
            if (p === 0) return;
            const a = 1 / (4 * p);
            const parabolaFunc = x => a * (x - h) * (x - h) + k;
            plotFunction(parabolaFunc, colors.parabola, 3);
            const xMin = fromCanvasX(0);

            drawPoint(h, k, colors.vertex);
            drawText(`V(${h.toFixed(1)}, ${k.toFixed(1)})`, h + 0.2, k - 0.2, colors.vertex, '14px Inter');

            const directrixY = k - p;
            if (checkDirectrix.checked) {
                drawLine(xMin, directrixY, fromCanvasX(canvas.width), directrixY, colors.directrix, 2, [5, 5]);
                drawText(`Directriz: y = ${directrixY.toFixed(2)}`, xMin + 0.2, directrixY - 0.2, colors.directrix, '12px Inter');
            }

            const focusX = h, focusY = k + p;
            if (checkFocus.checked) {
                drawPoint(focusX, focusY, colors.focus);
                drawText(`F(${focusX.toFixed(1)}, ${focusY.toFixed(1)})`, focusX + 0.2, focusY, colors.focus, '14px Inter');
            }

            if (checkInteractivePoint.checked) {
                const px = parabolaPointX, py = parabolaFunc(px);
                drawPoint(px, py, colors.interactive, 6);
                drawText(`P(${px.toFixed(2)}, ${py.toFixed(2)})`, px + 0.3, py + 0.5, colors.interactive, '14px Inter', 'left', 'top');
                if(checkFocus.checked) drawLine(px, py, focusX, focusY, colors.interactive, 2, [3, 3]);
                if(checkDirectrix.checked) drawLine(px, py, px, directrixY, colors.interactive, 2, [3, 3]);
            }
        }

        function draw() {
            requestAnimationFrame(() => {
                drawGridAndAxes();
                switch (activeSim) {
                    case 'sim1': drawSim1(); break;
                    case 'sim2': drawSim2(); break;
                    case 'sim3': drawSim3(); break;
                }
            });
        }
        
        function resetSimulation() {
            // Reset sliders to default values
            sliderA1.value = 0.5; sliderA2.value = 0.5;
            sliderB1.value = 0;   sliderB2.value = 0;
            sliderC1.value = 0;   sliderC2.value = 0;
            sliderP.value = 1;
            sliderH.value = 0;
            sliderK.value = 0;
            
            // Update value displays
            document.querySelectorAll('input[type="range"]').forEach(control => {
                const valueSpan = document.getElementById(control.id.replace('slider', 'value'));
                if(valueSpan) valueSpan.textContent = (+control.value).toFixed(2);
            });

            // Reset checkboxes
            checkTermA.checked = false;
            checkTermB.checked = false;
            checkTermC.checked = false;
            checkVertex.checked = true;
            checkVertexCoords.checked = true;
            checkAxis.checked = true;
            checkRoots.checked = true;
            checkRootsCoords.checked = true;
            checkFocus.checked = true;
            checkDirectrix.checked = true;
            checkInteractivePoint.checked = true;

            // Reset view
            scale = 70;
            
            // Go to first tab and redraw
            navButtons.sim1.click();
            resizeCanvas(); // This also calls draw()
        }

        // --- Event Listeners ---
        Object.keys(navButtons).forEach(key => {
            navButtons[key].addEventListener('click', () => {
                activeSim = key;
                Object.values(navButtons).forEach(btn => btn.classList.remove('btn-active'));
                navButtons[key].classList.add('btn-active');
                
                Object.keys(controlPanels).forEach(panelKey => {
                    controlPanels[panelKey].classList.toggle('hidden', panelKey !== key);
                    vizPanels[panelKey].classList.toggle('hidden', panelKey !== key);
                });
                
                canvas.style.cursor = activeSim === 'sim3' ? 'crosshair' : 'grab';
                draw();
            });
        });
        
        function syncSliders(source, targetVal, targetSlider) {
            const val = source.value;
            targetVal.textContent = (+val).toFixed(2);
            targetSlider.value = val;
        }

        sliderA1.addEventListener('input', () => syncSliders(sliderA1, valueA2, sliderA2));
        sliderB1.addEventListener('input', () => syncSliders(sliderB1, valueB2, sliderB2));
        sliderC1.addEventListener('input', () => syncSliders(sliderC1, valueC2, sliderC2));
        sliderA2.addEventListener('input', () => syncSliders(sliderA2, valueA1, sliderA1));
        sliderB2.addEventListener('input', () => syncSliders(sliderB2, valueB1, sliderB1));
        sliderC2.addEventListener('input', () => syncSliders(sliderC2, valueC1, sliderC1));

        document.querySelectorAll('input[type="range"], input[type="checkbox"]').forEach(control => {
            control.addEventListener('input', () => {
                if (control.type === 'range') {
                    const valueSpan = document.getElementById(control.id.replace('slider', 'value'));
                    if (valueSpan) {
                         let val = +control.value;
                         if (control.id === 'sliderP' && val === 0) { val = 0.1; control.value = 0.1; }
                         if ((control.id === 'sliderA1' || control.id === 'sliderA2') && val === 0) { val = 0.05; control.value = 0.05; }
                        valueSpan.textContent = val.toFixed(2);
                    }
                }
                draw();
            });
        });
        
        // --- Mouse Controls ---
        canvas.addEventListener('wheel', e => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left, mouseY = e.clientY - rect.top;
            const mousePosBefore = { x: fromCanvasX(mouseX), y: fromCanvasY(mouseY) };
            scale *= (e.deltaY < 0 ? 1.1 : 1 / 1.1);
            const mousePosAfter = { x: fromCanvasX(mouseX), y: fromCanvasY(mouseY) };
            origin.x += (mousePosAfter.x - mousePosBefore.x) * scale;
            origin.y -= (mousePosAfter.y - mousePosBefore.y) * scale;
            draw();
        });

        canvas.addEventListener('mousedown', e => { isDragging = true; dragStart = { x: e.clientX, y: e.clientY }; canvas.style.cursor = 'grabbing'; });
        canvas.addEventListener('mouseup', () => { isDragging = false; canvas.style.cursor = activeSim === 'sim3' ? 'crosshair' : 'grab'; });
        canvas.addEventListener('mouseleave', () => { isDragging = false; canvas.style.cursor = 'default'; });
        canvas.addEventListener('mousemove', e => {
            if (isDragging) {
                origin.x += e.clientX - dragStart.x;
                origin.y += e.clientY - dragStart.y;
                dragStart = { x: e.clientX, y: e.clientY };
            } else if (activeSim === 'sim3') {
                parabolaPointX = fromCanvasX(e.clientX - canvas.getBoundingClientRect().left);
            }
            draw();
        });

        // --- Touch Controls ---
        canvas.addEventListener('touchstart', e => {
            e.preventDefault();
            if (e.touches.length === 1) {
                isDragging = true;
                dragStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            } else if (e.touches.length === 2) {
                isDragging = false;
                pinchStartDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
            }
        }, { passive: false });

        canvas.addEventListener('touchend', e => {
            e.preventDefault();
            isDragging = false;
            pinchStartDist = 0;
        }, { passive: false });

        canvas.addEventListener('touchmove', e => {
            e.preventDefault();
            if (e.touches.length === 1 && isDragging) {
                origin.x += e.touches[0].clientX - dragStart.x;
                origin.y += e.touches[0].clientY - dragStart.y;
                dragStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            } else if (e.touches.length === 2) {
                if (pinchStartDist <= 0) return;
                const newPinchDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                const rect = canvas.getBoundingClientRect();
                const midpointX = (e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left;
                const midpointY = (e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top;
                const worldPosBefore = { x: fromCanvasX(midpointX), y: fromCanvasY(midpointY) };
                
                const scaleFactor = newPinchDist / pinchStartDist;
                scale *= scaleFactor;

                const worldPosAfter = { x: fromCanvasX(midpointX), y: fromCanvasY(midpointY) };
                origin.x += (worldPosAfter.x - worldPosBefore.x) * scale;
                origin.y -= (worldPosAfter.y - worldPosBefore.y) * scale;
                
                pinchStartDist = newPinchDist;
            } else if (activeSim === 'sim3' && e.touches.length === 1) {
                 parabolaPointX = fromCanvasX(e.touches[0].clientX - canvas.getBoundingClientRect().left);
            }
            draw();
        }, { passive: false });

        btnReset.addEventListener('click', resetSimulation);
        window.addEventListener('resize', resizeCanvas);

        // --- Inicialización ---
        resetSimulation();
    });
    </script>
</body>
</html>
